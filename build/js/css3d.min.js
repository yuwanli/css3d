!function(a){var b="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;"function"==typeof define&&define.amd?define(["exports"],function(c){b.C3D=a(b,c)}):"undefined"!=typeof exports?a(b,exports):b.C3D=a(b,{})}(function(a,b){function c(a){return Math.round(a)}function d(a){return Math.round(100*a)/100}function e(a){return a.replace(/\b(\w)|\s(\w)/g,function(a){return a.toUpperCase()})}function f(a){var c;switch(a.type){case"sprite":c=new b.Sprite(a.el?{el:a.el}:void 0);break;case"plane":c=new b.Plane(a.el?{el:a.el}:void 0);break;case"box":c=new b.Box(a.el?{el:a.el}:void 0);break;case"skybox":c=new b.Skybox(a.el?{el:a.el}:void 0)}if(void 0!=a.size&&c.size.apply(c,a.size),void 0!=a.position&&c.position.apply(c,a.position),void 0!=a.rotation&&c.rotation.apply(c,a.rotation),void 0!=a.scale&&c.scale.apply(c,a.scale),void 0!=a.origin&&c.origin.apply(c,a.origin),void 0!=a.visibility&&c.visibility.apply(c,a.visibility),void 0!=a.material&&c.material.apply(c,a.material),void 0!=a.filter&&c.filter.apply(c,a.filter),void 0!=a.name&&c.name.apply(c,[a.name]),void 0!=a.id&&c.id.apply(c,[a.id]),void 0!=a["class"]&&c["class"].apply(c,[a["class"]]),c.update(),a.children)for(var d=0,e=a.children.length;e>d;d++){var g=a.children[d],h=f(g);c.addChild(h)}return c}var g=function(a){var b=[];for(var c in a)b.push(c);return b},h=function(a){var b=arguments.length;if(2>b||null==a)return a;for(var c=1;b>c;c++)for(var d=arguments[c],e=g(d),f=e.length,h=0;f>h;h++){var i=e[h];a[i]=d[i]}return a},i=function(a,b){var c,d=this;c=a&&Object.prototype.hasOwnProperty.call(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},h(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&h(c.prototype,a),c.__super__=d.prototype,c},j="";return function(){var a=document.createElement("div"),b=["Webkit","Moz","Ms","O"];for(var c in b)if(b[c]+"Transform"in a.style){j=b[c];break}}(),b.getRandomColor=function(){return"#"+("00000"+(16777216*Math.random()<<0).toString(16)).slice(-6)},b.rgb2hex=function(a,b,c){return(a<<16|b<<8|c).toString(16)},b.hex2rgb=function(a){var b=Math.floor("0x"+a),c=b>>16&255,d=b>>8&255,e=255&b;return[c,d,e]},b.Object=function(){this.initialize.apply(this,arguments)},h(b.Object.prototype,{x:0,y:0,z:0,position:function(a,b,c){switch(arguments.length){case 1:this.x=a,this.y=a,this.z=a;break;case 2:this.x=a,this.y=b;break;case 3:this.x=a,this.y=b,this.z=c}return this},move:function(a,b,c){switch(arguments.length){case 1:this.x+=a,this.y+=a,this.z+=a;break;case 2:this.x+=a,this.y+=b;break;case 3:this.x+=a,this.y+=b,this.z+=c}return this},rotationX:0,rotationY:0,rotationZ:0,rotation:function(a,b,c){switch(arguments.length){case 1:this.rotationX=a,this.rotationY=a,this.rotationZ=a;break;case 2:this.rotationX=a,this.rotationY=b;break;case 3:this.rotationX=a,this.rotationY=b,this.rotationZ=c}return this},rotate:function(a,b,c){switch(arguments.length){case 1:this.rotationX+=a,this.rotationY+=a,this.rotationZ+=a;break;case 2:this.rotationX+=a,this.rotationY+=b;break;case 3:this.rotationX+=a,this.rotationY+=b,this.rotationZ+=c}return this},scaleX:1,scaleY:1,scaleZ:1,scale:function(a,b,c){switch(arguments.length){case 1:this.scaleX=a,this.scaleY=a,this.scaleZ=a;break;case 2:this.scaleX=a,this.scaleY=b;break;case 3:this.scaleX=a,this.scaleY=b,this.scaleZ=c}return this},width:0,height:0,depth:0,size:function(a,b,c){switch(arguments.length){case 1:this.width=a,this.height=a,this.depth=a;break;case 2:this.width=a,this.height=b;break;case 3:this.width=a,this.height=b,this.depth=c}return this},originX:0,originY:0,originZ:0,__orgO:{x:0,y:0,z:0},__orgT:{x:0,y:0,z:0},__orgF:{x:0,y:0,z:0},origin:function(a,b,c){switch(arguments.length){case 1:this.originX=a,this.originY=a,this.originZ=a;break;case 2:this.originX=a,this.originY=b;break;case 3:this.originX=a,this.originY=b,this.originZ=c}return this},__sort:["X","Y","Z"],sort:function(a,b,c){if(arguments.length>3)throw"sort arguments is wrong!";return this.__sort=[a,b,c],this},initialize:function(){this.x=0,this.y=0,this.z=0,this.rotationX=0,this.rotationY=0,this.rotationZ=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.width=0,this.height=0,this.depth=0,this.originX="50%",this.originY="50%",this.originZ="0px",this.__orgO={x:"50%",y:"50%",z:"0px"},this.__orgT={x:"-50%",y:"-50%",z:"0px"},this.__orgF={x:0,y:0,z:0},this.children=[]},parent:null,children:null,addChild:function(a){if(null!=a.parent&&a.parent.removeChild(a),""!=a.__name){if(void 0!==this[a.__name])throw a.__name+" already exist!";this[a.__name]=a}return this.children.push(a),a.parent=this,this},removeChild:function(a){for(var b=this.children.length-1;b>=0;b--)if(this.children[b]===a)return""!=a.__name&&delete this[a.__name],this.children.splice(b,1),a.parent=null,this;return this},removeAllChild:function(){for(var a=this.children.length-1;a>=0;a--){var b=this.children[a];""!=b.__name&&delete this[b.__name],b.parent=null}return this.children=[],this},remove:function(){return null!=this.parent&&this.parent.removeChild(this),this}}),b.Object.extend=i,b.Sprite=b.Object.extend({el:null,alpha:1,visible:!0,initialize:function(a){b.Sprite.__super__.initialize.apply(this,[a]),this.__name="",this.__id="",this.__class="",this.alpha=1,this.visible=!0;var c;if(a&&a.el)switch(typeof a.el){case"string":c=document.createElement("div"),c.innerHTML=a.el;break;case"object":1===a.el.nodeType&&(c=a.el)}c||(c=document.createElement("div")),c.style.position="absolute",c.style[j+"Transform"]="translateZ(0px)",c.style[j+"TransformStyle"]="preserve-3d",this.el=c,c.le=this},__name:"",name:function(a){return this.__name=a,""==a?delete this.el.dataset.name:this.el.dataset.name=a,this},__id:"",id:function(a){return this.__id=a,this.el.id=a,this},__class:"","class":function(a){return this.__class=a,this.el.className=a,this},update:function(){return this.updateS(),this.updateM(),this.updateO(),this.updateT(),this.updateV(),this},updateS:function(){return this},updateM:function(){if(!this.__mat)return this;for(var a in this.__mat)switch(a){case"bothsides":this.el.style[j+"BackfaceVisibility"]=this.__mat[a]?"visible":"hidden";break;case"image":this.el.style["background"+e(a)]=""!==this.__mat[a]?"url("+this.__mat[a]+")":"";break;default:this.el.style["background"+e(a)]=this.__mat[a]}return this},updateO:function(){if("number"==typeof this.originX){var a=c(this.originX-this.__orgF.x);this.__orgO.x=a+"px",this.__orgT.x=-a+"px"}else this.__orgO.x=this.originX,this.__orgT.x="-"+this.originX;if("number"==typeof this.originY){var b=c(this.originY-this.__orgF.y);this.__orgO.y=b+"px",this.__orgT.y=-b+"px"}else this.__orgO.y=this.originY,this.__orgT.y="-"+this.originY;if("number"==typeof this.originZ){var d=c(this.originZ-this.__orgF.z);this.__orgO.z=d+"px",this.__orgT.z=-d+"px"}else this.__orgO.z=this.__orgT.z="0px";return this.el.style[j+"TransformOrigin"]=this.__orgO.x+" "+this.__orgO.y+" "+this.__orgO.z,this},updateT:function(){var a=this.__sort[0],b=this.__sort[1],c=this.__sort[2];return this.el.style[j+"Transform"]="translate3d("+this.__orgT.x+", "+this.__orgT.y+", "+this.__orgT.z+") translate3d("+d(this.x)+"px,"+d(this.y)+"px,"+d(this.z)+"px) rotate"+a+"("+d(this["rotation"+a])%360+"deg) rotate"+b+"("+d(this["rotation"+b])%360+"deg) rotate"+c+"("+d(this["rotation"+c])%360+"deg) scale3d("+d(this.scaleX)+", "+d(this.scaleY)+", "+d(this.scaleZ)+") ",this},updateV:function(){return this.el.style.opacity=this.alpha,this.el.style.display=this.visible?"block":"none",this},addChild:function(a){return b.Sprite.__super__.addChild.apply(this,[a]),this.el&&a.el&&this.el.appendChild(a.el),this},removeChild:function(a){for(var b=this.children.length-1;b>=0;b--)if(this.children[b]===a)return""!=a.__name&&delete this[a.__name],this.children.splice(b,1),a.parent=null,this.el.removeChild(a.el),this;return this},removeAllChild:function(){for(var a=this.children.length-1;a>=0;a--){var b=this.children[a];""!=b.__name&&delete this[b.__name],b.parent=null,this.el.removeChild(b.el)}return this.children=[],this},on:function(a){if("object"==typeof a)for(var b in a)this.el.addEventListener(b,a[b],!1);else 2===arguments.length?this.el.addEventListener(arguments[0],arguments[1],!1):3===arguments.length&&this.el.addEventListener(arguments[0],arguments[1],arguments[2]);return this},off:function(a){if("object"==typeof a)for(var b in a)this.el.removeEventListener(b,a[b],!1);else 2===arguments.length&&this.el.removeEventListener(arguments[0],arguments[1],!1);return this},buttonMode:function(a){return a?this.el.style.cursor="pointer":this.el.style.cursor="auto",this},__mat:null,material:function(a){return this.__mat=a,this},visibility:function(a){return void 0!==a.visible&&(this.visible=a.visible),void 0!==a.alpha&&(this.alpha=a.alpha),this}}),b.Stage=b.Sprite.extend({camera:null,fov:null,__rfix:null,__pfix:null,initialize:function(a){b.Stage.__super__.initialize.apply(this,[a]),a&&a.el||(this.el.style.top="0px",this.el.style.left="0px",this.el.style.width="0px",this.el.style.height="0px"),this.el.style[j+"Perspective"]="800px",this.el.style[j+"TransformStyle"]="flat",this.el.style[j+"Transform"]="",this.el.style.overflow="hidden",this.__rfix=new b.Sprite,this.el.appendChild(this.__rfix.el),this.__pfix=new b.Sprite,this.__rfix.el.appendChild(this.__pfix.el),this.setCamera(new b.Camera)},updateS:function(){return this.el.style.width=c(this.width)+"px",this.el.style.height=c(this.height)+"px",this},updateT:function(){return this.fov=c(.5/Math.tan(.5*this.camera.fov/180*Math.PI)*this.height),this.el.style[j+"Perspective"]=this.fov+"px",this.__rfix.position(c(this.width/2),c(this.height/2),this.fov).rotation(-this.camera.rotationX,-this.camera.rotationY,-this.camera.rotationZ).updateT(),this.__pfix.position(-this.camera.x,-this.camera.y,-this.camera.z).updateT(),this},addChild:function(a){return this.__pfix.addChild(a),this},removeChild:function(a){return this.__pfix.removeChild(a),this},setCamera:function(a){return this.camera&&(this.camera.stage=null),this.camera=a,this.camera.stage=this,this}}),b.Camera=b.Object.extend({fov:null,stage:null,initialize:function(a){b.Camera.__super__.initialize.apply(this,[a]),this.fov=75},update:function(){return this.updateT(),this},updateS:function(){return this},updateM:function(){return this},updateT:function(){return this.stage&&this.stage.updateT(),this},updateV:function(){return this}}),b.Plane=b.Sprite.extend({initialize:function(a){b.Plane.__super__.initialize.apply(this,[a])},update:function(){return b.Plane.__super__.update.apply(this),this.updateF(),this},updateS:function(){return this.el.style.width=c(this.width)+"px",this.el.style.height=c(this.height)+"px",this},updateF:function(){if(!this.__flt)return this;var a="";for(var b in this.__flt)a+=""!==this.__flt[b]?b+"("+this.__flt[b].join(",")+")":"";return""!==a&&(this.el.style[j+"Filter"]=a),this},__flt:null,filter:function(a){return this.__flt=a,this}}),b.Box=b.Sprite.extend({front:null,back:null,left:null,right:null,up:null,down:null,initialize:function(a){b.Box.__super__.initialize.apply(this,[a]),this.front=new b.Plane,this.front.name="front",this.addChild(this.front),this.back=new b.Plane,this.back.name="back",this.addChild(this.back),this.left=new b.Plane,this.left.name="left",this.addChild(this.left),this.right=new b.Plane,this.right.name="right",this.addChild(this.right),this.up=new b.Plane,this.up.name="up",this.addChild(this.up),this.down=new b.Plane,this.down.name="down",this.addChild(this.down)},update:function(){return b.Box.__super__.update.apply(this),this.updateF(),this},updateS:function(){var a=c(this.width),b=c(this.height),d=c(this.depth);return this.__orgF.x=this.width/2,this.__orgF.y=this.height/2,this.__orgF.z=this.depth/2,this.front.size(a,b,0).position(0,0,d/2).rotation(0,0,0).updateS().updateT(),this.back.size(a,b,0).position(0,0,-d/2).rotation(0,180,0).updateS().updateT(),this.left.size(d,b,0).position(-a/2,0,0).rotation(0,-90,0).updateS().updateT(),this.right.size(d,b,0).position(a/2,0,0).rotation(0,90,0).updateS().updateT(),this.up.size(a,d,0).position(0,-b/2,0).rotation(90,0,0).updateS().updateT(),this.down.size(a,d,0).position(0,b/2,0).rotation(-90,0,0).updateS().updateT(),this},updateM:function(){if(!this.__mat)return this;var a=!0;for(var b in this.__mat)switch(b){case"front":case"back":case"left":case"right":case"up":case"down":void 0==this.__mat[b].bothsides&&(this.__mat[b].bothsides=!1),this[b].material(this.__mat[b]).updateM(),a=!1}return a&&(void 0==this.__mat.bothsides&&(this.__mat.bothsides=!1),this.front.material(this.__mat).updateM(),this.back.material(this.__mat).updateM(),this.left.material(this.__mat).updateM(),this.right.material(this.__mat).updateM(),this.up.material(this.__mat).updateM(),this.down.material(this.__mat).updateM()),this},updateF:function(){return this.__flt?(this.front.filter(this.__flt).updateF(),this.back.filter(this.__flt).updateF(),this.left.filter(this.__flt).updateF(),this.right.filter(this.__flt).updateF(),this.up.filter(this.__flt).updateF(),this.down.filter(this.__flt).updateF(),this):this},__flt:null,filter:function(a){return this.__flt=a,this}}),b.Skybox=b.Box.extend({updateS:function(){var a=c(this.width),b=c(this.height),d=c(this.depth);return this.__orgF.x=this.width/2,this.__orgF.y=this.height/2,this.__orgF.z=this.depth/2,this.front.size(a,b,0).position(0,0,-d/2).rotation(0,0,0).updateS().updateT(),this.back.size(a,b,0).position(0,0,d/2).rotation(0,180,0).updateS().updateT(),this.left.size(d,b,0).position(-a/2,0,0).rotation(0,90,0).updateS().updateT(),this.right.size(d,b,0).position(a/2,0,0).rotation(0,-90,0).updateS().updateT(),this.up.size(a,d,0).position(0,-b/2,0).rotation(-90,0,0).updateS().updateT(),this.down.size(a,d,0).position(0,b/2,0).rotation(90,0,0).updateS().updateT(),this}}),b.create=function(a){var b;switch(typeof a){case"array":b={type:"sprite",children:a};break;case"object":b=a;break;default:return}return f(b)},b});